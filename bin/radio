#!/bin/bash
# vi: ts=4:sw=4:et:
dir=$XDG_RUNTIME_DIR/radio
[ ! -d $dir ] && mkdir -p $dir

get_winid()
{
    if [ -e "$dir/winid" ]; then
        cat "$dir/winid"
    else
        echo "Radio is not running" >&2
        exit 1
    fi
}

get_windowname()
{
    winid=$(get_winid) || return $?
    raw=$(xdotool getwindowname $winid 2>/dev/null) || return $?
    echo "$raw" | sed 's/ - Mozilla Firefox//; s/&/&amp;/g; s/</&lt;/g; s/>/&gt;/g'
}

get_windowname_old()
{
    cat $dir/windowname
}

save_windowname()
{
    echo "$1" > $dir/windowname
}

start_radio()
{
    URL="$1"
    firefox -P radio $URL &
    pid=$!
    winwait_sec=30
    while ! winid=$(xdotool search --onlyvisible --pid $pid); do
        echo "$winid"
        sleep 1
        winwait_sec=$((winwait_sec-1))
        if [ $winwait_sec -eq 0 ]; then
            echo "Radio window not found"
            exit 1
        fi
    done
    echo $winid > $dir/winid
    i3-msg "[id=$winid] move window to workspace 8:üéú"
}

stop_radio()
{
    winid=$(get_winid) || return $?
    xdotool windowclose $winid && rm -f $dir/*
}

sendkey()
{
    key="$1"
    winid=$(get_winid) || return $?
    xdotool key --window $winid $key
}

state()
{
    windowname=$(get_windowname)
    result=$?
    if [ $result -ne 0 ]; then
        echo "not running"
        exit
    elif echo "$windowname" | grep -q "–Ø–Ω–¥–µ–∫—Å\.\(–†–∞–¥–∏–æ\|–ú—É–∑—ã–∫–µ\)"; then
        echo "paused"
        exit
    else
        echo "playing"
    fi
}

title()
{
    inside_i3blocks=false
    [ -n "$BLOCK_NAME" ] && inside_i3blocks=true
    winid=$(get_winid) || return 0
    state=$(state)
    windowname_old=$(get_windowname_old)
    windowname=$(get_windowname)
    echo "$(date --rfc-3339=seconds) state='$state' windowname='$windowname' windowname_old='$windowname_old'" >> /tmp/radio.log
    case "$state" in
        "not running")
            echo ""
            if [ -n "$windowname_old" ]; then
                save_windowname ""
            fi
            exit
            ;;

        "paused")
            if $inside_i3blocks; then
                if [ "$windowname_old" == "–†–µ–∫–ª–∞–º–∞" ]; then
                    save_windowname ""
                    pause
                    sleep 2
                    refresh_i3blocks
                    exit
                elif [ -z "$windowname_old" ]; then
                    windowname_old='Radio is starting...'
                fi
                echo '<span color="#aaa">‚è∏</span><span font="11" face="PT Sans" color="#888"> '$windowname_old'</span>'
            else
                echo "$windowname_old"
            fi
            exit
            ;;

        "playing")
            $inside_i3blocks \
                && echo '<span font="11" face="PT Sans" color="#aaa">‚ñ∂Ô∏è '$windowname'</span>' \
                || echo "$windowname"
            if [ "$windowname" != "$windowname_old" ]; then
                if [ "$windowname" == "–†–µ–∫–ª–∞–º–∞" ] || [ "$windowname_old" == "–†–µ–∫–ª–∞–º–∞" ]; then
                    sendkey 0
                fi
                save_windowname "$windowname"
            fi
            ;;
    esac
}

pause()
{
    sendkey p
}

next()
{
    sendkey l
}

refresh_i3blocks()
{
    delay=0.2
    if [ "$1" ]; then
        delay=$1
    fi
    sleep $delay
    pkill -RTMIN+11 i3blocks
}


# Mouse Clicked in i3bar
if [ "$BLOCK_BUTTON" != "" ]; then
    # 1:left, 2:mid, 3:right, 4:scrollup, 5:scrolldown
    case $BLOCK_BUTTON in
        1) pause; sleep 0.1;;
        3) next; sleep 1;;
        4) vol up; exit 1;; # error to preserve i3bar title
        5) vol down; exit 1;;
    esac
fi

case $1 in
    start|start-music)
        if [ "$1" == 'start-music' ]; then
            URL=https://music.yandex.ru/
        else
            URL=https://radio.yandex.ru/user/bomb-da-base
        fi
        start_radio "$URL"
        ;;
    pause)
        prev_state=$(state)
        pause
        if [ "$prev_state" == "playing" ]; then
            refresh_i3blocks 0
        else
            refresh_i3blocks
        fi
        ;;
    next)  next; refresh_i3blocks ;;
    state) state ;;
    stop)  stop_radio ;;
    title) title ;;
    pause-if-playing)
        state=$(state)
        if [ "$state" == "playing" ]; then
            pause
        fi
        ;;
esac
